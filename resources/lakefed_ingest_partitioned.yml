resources:
  jobs:
    lakefed_ingest_partitioned:
      name: "lakefed_ingest_partitioned"
      tasks:
        - task_key: config
          notebook_task:
            notebook_path: ../src/lakefed_ingest/config_ingest_partitioned.ipynb
            source: WORKSPACE
          existing_cluster_id: ${var.cluster_id}
          libraries:
            - whl: ../dist/*.whl
        - task_key: foreach_task_id
          depends_on:
            - task_key: config
          for_each_task:
            inputs: "{{tasks.config.values.id_list}}"
            concurrency: ${var.concurrency}
            task:
              task_key: copy_data
              notebook_task:
                notebook_path: ../src/lakefed_ingest/copy_data_partitioned.ipynb
                source: WORKSPACE
                warehouse_id: ${var.warehouse_id}
                base_parameters:
                  partition_id: "{{input}}"
              max_retries: 2
              min_retry_interval_millis: 0
      tags:
        workload: lakefed_ingest
      queue:
        enabled: false
      parameters:
        - name: src_type
          default: postgresql
        - name: src_catalog
          default: lakefed_ingest_src
        - name: src_schema
          default: public
        - name: src_table
          default: lakefed_src
        - name: partition_col
          default: customer_id
        - name: partition_size_mb
          default: "256"
        - name: tgt_catalog
          default: lakefed_ingest
        - name: tgt_schema
          default: default
        - name: tgt_table
          default: lakefed_tgt
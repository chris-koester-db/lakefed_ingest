resources:
  jobs:
    lakehouse_federation_bulk_ingest:
      name: "Lakehouse Federation Bulk Ingest"
      tasks:
        - task_key: config
          notebook_task:
            notebook_path: ../notebooks/config.ipynb
            source: WORKSPACE
          existing_cluster_id: ${var.existing_cluster_id}
          libraries:
            - whl: ../dist/*.whl
        - task_key: foreach_task_id
          depends_on:
            - task_key: config
          for_each_task:
            inputs: "{{tasks.config.values.id_list}}"
            concurrency: 8
            task:
              task_key: run_query
              notebook_task:
                notebook_path: ../notebooks/run_query.ipynb
                base_parameters:
                  task_id: "{{input}}"
                source: WORKSPACE
              existing_cluster_id: ${var.existing_cluster_id}
              max_retries: 3
              min_retry_interval_millis: 0
      tags:
        workload: lakefed_bulk_ingest
      queue:
        enabled: false
      parameters:
        - name: src_type
          default: postgresql
        - name: src_catalog
          default: lakefed_bulk_ingest_src
        - name: src_schema
          default: public
        - name: src_table
          default: lakefed_src
        - name: partition_col
          default: customer_id
        - name: partition_size_mb
          default: "256"
        - name: root_dir
          default: ${workspace.file_path}
        - name: jdbc_config_file
          default: ""
        - name: tgt_ddl_file_path
          default: config/ddl_create_lakefed_tgt.txt
        - name: tgt_catalog
          default: lakefed_bulk_ingest
        - name: tgt_schema
          default: default
        - name: tgt_table
          default: lakefed_tgt